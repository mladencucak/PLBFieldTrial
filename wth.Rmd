%Wth

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE)

chooseCRANmirror(graphics=FALSE, ind=1)
knitr::knit_hooks$set(
  source = function(x, options) {
    hook.r = function(x, options) {
      fence <- "```"
      language = tolower(options$engine)
      if (language == 'node') language = 'javascript'
      if (!options$highlight) language = 'text'
      if(!is.null(options$foldcode)) {
      paste0('\n\n', "<details><summary>The code</summary>\n", fence, language, '\n', x, fence,  '\n\n', "</details>\n")
      } else {
              paste0('\n\n', fence, language, '\n', x, fence,  '\n\n')
      }
    }
    x = knitr:::hilight_source(x, 'markdown', options)
    hook.r(
      paste(c(
        x, 
        ''
      ), collapse = '\n'), 
      options
    )
  }
)

```

```{r libs, warning = FALSE, message= FALSE}
list.of.packages <-
  c(
    "tidyverse",
    "devtools",
    "egg",
    "ggpubr",
    "zoo",
    "kableExtra"
  )

new.packages <-
  list.of.packages[!(list.of.packages %in% installed.packages()[, "Package"])]

#Download packages that are not already present in the library
if (length(new.packages))
  install.packages(new.packages)

packages_load <-
  lapply(list.of.packages, require, character.only = TRUE)

#Print warning if there is a problem with installing/loading some of packages
if (any(as.numeric(packages_load) == 0)) {
  warning(paste("Package/s: ", paste(list.of.packages[packages_load != TRUE], sep = ", "), "not loaded!"))
} else {
  print("All packages were successfully loaded.")
}
rm(list.of.packages, new.packages, packages_load)

#if instal is not working try 
#install.packages("ROCR", repos = c(CRAN="https://cran.r-project.org/"))
```


## Load the data
 
```{r cars}

library(lubridate)
df <- 
read_csv(
  here::here("data", "weather" , "hly375.csv"),
  col_types = cols(
    clamt = col_skip(),
    clht = col_skip(),
    vis = col_skip(),
    w = col_skip(),
    ww = col_skip()
  ),
  skip = 17
)

df$date <-
  lubridate::dmy_hm(df$date)
df<- add_column(df, short_date = as.Date(df$date), .after=1)
df<- add_column(df, year = year(df$date), .after=2)
df<- add_column(df, month = month(df$date), .after=3)
df<- add_column(df, day = day(df$date), .after=4)
df<- add_column(df, doy = yday(df$date), .after=4)
df<- add_column(df, hour = hour(df$date), .after="day")


infil_gap <- 8 #Maximum length of the infill gap
df$temp <-
  round(na.spline(df$temp, na.rm = FALSE, maxgap = infil_gap), 1)
df$rhum <-
  round(na.spline(df$rhum, na.rm = FALSE, maxgap = infil_gap), 0)
df$rhum  <- sapply(df$rhum, function(x)
  ifelse(x > 100, x <- 100, x))
#Check if the imputation worked
df %>% group_by(year)  %>%
  filter(month %in% c(4:9)) %>%
  summarize(
    NA_rain = sum(is.na(rain)),
    NA_temp = sum(is.na(temp)),
    NA_rhum = sum(is.na(rhum))
  )%>% 
  kable(format = "html") %>% 
  kableExtra::kable_styling(latex_options = "striped",full_width = FALSE)



df_rain <- 
  df %>%
  filter(month %in% c(4:10)) %>%
  group_by(year) %>%
  summarize(rain = sum(rain)) %>% 
  ungroup() %>% 
  summarize(rain = mean(rain)) 
df %>%
  filter(month %in% c(4:10)) %>%
  summarize(temp = round(mean(temp),1),
            rhum = round(mean(rhum),1)
  ) %>% 
  bind_cols(., df_rain) %>% 
  kable(caption = "10 Year Averages Weather at Oak Park",format = "html") %>% 
  kableExtra::kable_styling(latex_options = "striped",full_width = FALSE)



df %>%
  filter(month %in% c(4:9)) %>%
  filter(year %in% c(2016:2019)) %>%
  group_by(year, month) %>% 
  summarize(temp = round(mean(temp),1),
            rain = sum(rain, na.rm = TRUE),
            wdsp = mean(wdsp, na.rm = TRUE),
            rhum = round(mean(rhum, na.rm = TRUE),1)
            
  ) 


df %>%
  filter(month %in% c(4:9)) %>%
  group_by( month) %>% 
  summarize(temp = round(mean(temp, na.rm =TRUE ),1),
            rain = sum(rain, na.rm = TRUE),
            wdsp = mean(wdsp, na.rm = TRUE),
            rhum = round(mean(rhum, na.rm = TRUE),1)
            
  ) 



df %>%
  filter(month %in% c(4:9)) %>%
  filter(year %in% c(2016:2019)) %>%
  group_by(year, month, short_date) %>% 
  summarize(temp = round(mean(temp),1),
            rain = sum(rain),
            wdsp = mean(wdsp),
            rhum = round(mean(rhum),1)
            
  ) %>%
  mutate(rain = ifelse(rain == 0, NA, rain)) %>% 
  rename(date = short_date) %>% 
  ggplot() +
  geom_line(
    aes(
      x = date,
      y = rhum,
      color = "Relative humidity (%)",
      fill = "Relative humidity (%)"
    ),
    size = 0.1
  ) +
  geom_line(aes(
    x = date,
    y = temp,
    colour = "Temperature (˚C)",
    fill = "Temperature (˚C)",
  ),
  size = 0.15) +
  geom_col(
    aes(date,
        rain,
        colour = "Precipitation (mm/day)",
        fill = "Precipitation (mm/day)"),
    size = 1 ,
    inherit.aes = TRUE,
    width = 0.03
  ) +
  geom_hline(aes(yintercept = 88,
                 linetype = "88 % RH"),
             colour = "#ff7f00",
             size = 0.3) +
  geom_hline(aes(yintercept = 10,
                 linetype = "10 ˚C"),
             colour = "#fb9a99",
             size = 0.3) +
  labs(x = "", y = "T (˚C), PR (mm), RH (%) and Wind (m/s)") +
  scale_colour_manual(
    "Weather",
    values = c(
      "Relative humidity (%)" = "lightblue",
      "Temperature (˚C)" = "#e31a1c",
      "Precipitation (mm/day)" = "blue"
    )
  ) +
  scale_fill_manual(
    "Weather",
    values = c(
      "Relative humidity (%)" =  "lightblue",
      "Temperature (˚C)" = "#e31a1c",
      "Precipitation (mm/day)" = "blue"
    )
  ) +
  scale_linetype_manual(name = "Risk Limits",
                        values = c(1, 2, 3)) +
  theme_article() +
  theme(
    plot.title = element_text(size = 22),
    # axis.title.x = element_blank(),
    # axis.text.x = element_blank(),
    # axis.ticks.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    legend.position = "right"
  ) +
  scale_x_date(date_labels = "%b", date_breaks = "1 month")+
  facet_wrap(. ~ year, scales = "free_x", ncol = 1,strip.position="right") +
  guides(fill=guide_legend(nrow=3,byrow=TRUE))+
  ggsave(filename= here::here("results", "wth", "all_wth.png"), 
         width = 8, height =7, dpi = 620)

```
