% Pop3

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
chooseCRANmirror(graphics=FALSE, ind=1)
knitr::knit_hooks$set(
  source = function(x, options) {
    hook.r = function(x, options) {
      fence <- "```"
      language = tolower(options$engine)
      if (language == 'node') language = 'javascript'
      if (!options$highlight) language = 'text'
      if(!is.null(options$foldcode)) {
      paste0('\n\n', "<details><summary>The code</summary>\n", fence, language, '\n', x, fence,  '\n\n', "</details>\n")
      } else {
              paste0('\n\n', fence, language, '\n', x, fence,  '\n\n')
      }
    }
    x = knitr:::hilight_source(x, 'markdown', options)
    hook.r(
      paste(c(
        x, 
        ''
      ), collapse = '\n'), 
      options
    )
  }
)

```

## Popoulation analysis 

 After gaining insight into population structure we can move onto the analysis of 

## Load packages
```{r libs, warning = FALSE, message= FALSE}
list.of.packages <-
  c(
    "tidyverse",
    "devtools",
    "here",
    "readxl",
    "poppr",
    "egg",
    "parallel"
  )

new.packages <-
  list.of.packages[!(list.of.packages %in% installed.packages()[, "Package"])]

#Download packages that are not already present in the library
if (length(new.packages))
  install.packages(new.packages)

packages_load <-
  lapply(list.of.packages, require, character.only = TRUE)

#Print warning if there is a problem with installing/loading some of packages
if (any(as.numeric(packages_load) == 0)) {
  warning(paste("Package/s: ", paste(list.of.packages[packages_load != TRUE], sep = ", "), "not loaded!"))
} else {
  print("All packages were successfully loaded.")
}
rm(list.of.packages, new.packages, packages_load)

#if instal is not working try 
#install.packages("package_name", repos = c(CRAN="https://cran.r-project.org/"))
```

## Data import/preparation



```{r load_data}
path <- here::here("data", "gen data", "final", "pop.csv")

monpop <- read.genalex(path, ploidy = 3)

splitStrata(monpop) <- ~variety/genotype/year

monpop

#Set genotype id's
 monpop$strata<-
  monpop$strata %>% 
mutate(genotype = ifelse( genotype ==  "8A1-1","EU_8_1_A1",
                                   ifelse(genotype ==  "6A1","EU_6_A1",
                                          ifelse(genotype ==  "13A2","EU_13_A2",
                                                 ifelse(genotype ==  "8A1","EU_8_A1","" )))))
 

  
cbbPalette <- c ("#ff33cc",  "#ffff33","#3399ff","#F3DA60") 

```

## DAPC
Very good tutorials are avaialble at [adegent page](https://github.com/thibautjombart/adegenet/wiki/Tutorials) and [GrÃ¼nwald lab web page](https://grunwaldlab.github.io/Population_Genetics_in_R/DAPC.html).  
Set paralel processing. This argument should be removed if the code is to be reproduced on machine which can not devote muliple cores, although that is probably not a good idea.   
We will also assign a number of cores to be used. WE will set it to be one les than maximum no. of cores, so we dont 'sufficate' the computer. 

```{r}
#Determine the OS to assign apropriate character string for parallel processing
 parallel_proc <- 
  ifelse(Sys.info()['sysname'] == "Windows", "snow", "multicore") 

cpus <-  ifelse(detectCores()>1, c(detectCores()-1), 1)
cpus
```


```{r dapc_var}
set.seed(999)
setPop(monpop) <- ~variety
pramx <- xvalDapc(tab(monpop, NA.method = "mean"), pop(monpop))


set.seed(999)
system.time(pramx <- xvalDapc(tab(monpop, NA.method = "mean"), pop(monpop),
                              n.pca = 10:20, n.rep = 1000,
                              parallel = parallel_proc, 
                              ncpus = cpus))
pramx[2:6]
pramx[-1]
pramx[-1]$`Number of PCs Achieving Highest Mean Success`


scatter(
  pramx$DAPC,
  # col = other(monpop)$comparePal,
  cex = 1.5 ,
  pch=18:23,
  legend = TRUE,
  clabel = TRUE,
  posi.leg = "topright",
  scree.pca = TRUE,
  posi.da = "bottom",
  posi.pca = "topleft",
  cleg = .9,
  xax = 1,
  yax = 2,
  inset.solid = 1,
  ratio.da = .2
)

dev.copy(png,filename=here::here("results", "gen","dapc", "var.png"),
         width =600, height= 600);
dev.off ()

```
  
  Prepare the data in genalex format once again. We can define only thre stratums, so we will prepare another file which will be re-used for same purpose as above.  

```{r genalex_new}
fin <-  readRDS(file = here::here("data", "gen data", "final", "gendata.rds") )

fin <- 
  unite(fin, "Ind", idd, year, remove = F)

fin <- 
  unite(fin, "Pop", treatment, Genotype, year) 


 popcol <- match("Pop",names(fin))
 idcol <- match("Ind",names(fin))


gen <- 
fin[ , c(idcol,popcol,match("D13",names(fin)):match("X__24",names(fin)))]


path <- here::here("data", "gen data", "final", "pop2.csv")

data.frame(ssr = c(12,"PInf_Ireland"), 
           samples = nrow(gen), 
           pop =  length(unique(fin$Pop)))

write.table(data.frame(ssr = 12, samples = nrow(gen), pop =  length(unique(fin$Pop))),
            path,
            sep=",",  col.names=FALSE, row.names = FALSE)

write.table( "PInf_Ireland",
            path,
            sep = ",", row.names = FALSE,
            col.names = FALSE, append = T)
names(gen)[grep("X__", names(gen))] <- ""

write.table(gen,
            path,
            sep = ",", 
            row.names = FALSE,
            col.names = !file.exists("myDF.csv"), append = T)

```
  
  So now we have created another file in genalex format, pop2.csv.

```{r import_genalex}
path <- here::here("data", "gen data", "final", "pop2.csv")

monpop <- read.genalex(path, ploidy = 3)

splitStrata(monpop) <- ~treatment/genotype/year

monpop

#Set genotype id's
 monpop$strata<-
  monpop$strata %>% 
mutate(genotype = ifelse( genotype ==  "8A1-1","EU_8_1_A1",
                                   ifelse(genotype ==  "6A1","EU_6_A1",
                                          ifelse(genotype ==  "13A2","EU_13_A2",
                                                 ifelse(genotype ==  "8A1","EU_8_A1","" )))))
 

  
cbbPalette <- c ("#ff33cc",  "#ffff33","#3399ff","#F3DA60") 

```



```{r dapc_trt}
set.seed(999)
setPop(monpop) <- ~treatment

set.seed(999)
system.time(pramx <- xvalDapc(tab(monpop, NA.method = "mean"), pop(monpop),
                              n.pca = 5:30, 
                              n.rep = 1000,
                              parallel = parallel_proc, 
                              ncpus = cpus))
pramx[-1]
pramx[-1]$`Number of PCs Achieving Highest Mean Success`

scatter(
  pramx$DAPC,
  # col = other(monpop)$comparePal,
  cex = 1.3 ,
  legend = TRUE,
  clabel = TRUE,
  posi.leg = "topleft",
  scree.pca = FALSE,
  posi.pca = "topright",
  posi.da = "bottomright",
  cleg = .9,
  xax = 1,
  yax = 2,
  inset.solid = 1
)

dev.copy(png,filename=here::here("results", "gen","dapc", "treatment.png"),
         width = 600, height= 600);
dev.off ()

```



```{r dapc_year}
set.seed(999)
setPop(monpop) <- ~year

set.seed(999)
system.time(pramx <- xvalDapc(tab(monpop, NA.method = "mean"), pop(monpop),
                              n.pca = 5:30, 
                              n.rep = 1000,
                              parallel = parallel_proc, 
                              ncpus = cpus))
pramx[-1]
pramx[-1]$`Number of PCs Achieving Highest Mean Success`

scatter(
  pramx$DAPC,
  # col = other(monpop)$comparePal,
  cex = 1.3 ,
  legend = TRUE,
  clabel = TRUE,
  posi.leg = "bottomleft",
  scree.pca = TRUE,
  posi.pca = "topright",
  posi.da = "topleft",
  cleg = .9,
  xax = 1,
  yax = 2,
  inset.solid = 1
)

dev.copy(png,filename=here::here("results", "gen","dapc", "year.png"),
         width = 600, height= 600);
dev.off ()


```



```{r}

```



```{r}

```



```{r}

```


```{r}
session_info()
```

